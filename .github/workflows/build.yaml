name: Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest

        # For this to work, you also need to set CACHIX_AUTH_TOKEN secret in your repository secrets settings.
        cachixName:
          - dsully

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Install nix
      uses: cachix/install-nix-action@v31
      with:
        enable_kvm: false
        extra_nix_config: |
          experimental-features = nix-command flakes
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Setup cachix
      uses: cachix/cachix-action@v16
      # Don't replace <YOUR_CACHIX_NAME> here!
      if: ${{ matrix.cachixName != '<YOUR_CACHIX_NAME>' }}
      with:
        name: ${{ matrix.cachixName }}
        signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
        authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"

    - name: Build with Nix
      run: nix build .
    
    - name: Push to Cachix
      run: |
        nix store sign --key-file ~/.config/nix/signing-key.sec --recursive ./result
        nix copy --to cachix://nix-package-updater ./result
